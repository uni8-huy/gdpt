name: Deploy to Fly.io

on:
  push:
    branches: [main]

env:
  FLY_APP: ${{ vars.FLY_APP_NAME || 'gdpt' }}

jobs:
  deploy:
    name: Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --app $FLY_APP
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Check app status
        run: flyctl status --app $FLY_APP
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Wait for app to be healthy
        run: |
          echo "Waiting for app to start..."
          for i in {1..30}; do
            STATUS=$(flyctl status --app $FLY_APP --json 2>/dev/null | jq -r '.Machines[0].state // "unknown"' 2>/dev/null || echo "unknown")
            echo "Attempt $i: Machine state is $STATUS"
            if [ "$STATUS" = "started" ]; then
              echo "App is running!"
              sleep 10  # Give it extra time to be fully ready
              exit 0
            fi
            sleep 10
          done
          echo "App failed to start within timeout"
          echo "=== Recent Logs ==="
          flyctl logs --app $FLY_APP --no-tail || true
          exit 1
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Ensure machine is running for migrations
        run: |
          MACHINE_ID=$(flyctl status --app $FLY_APP --json | jq -r '.Machines[0].id')
          flyctl machine start $MACHINE_ID --app $FLY_APP || true
          sleep 10
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Run database migrations
        run: flyctl ssh console --app $FLY_APP -C "node node_modules/prisma/build/index.js db push --skip-generate --accept-data-loss"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
